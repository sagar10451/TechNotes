# AWS Scalability and High Availability

## Scaling Concepts

### Vertical Scaling
- Increasing size of instance
- Common in non-distributed systems such as database
- Hardware limit to vertical scaling

### Horizontal Scaling
- Increasing number of instances/machines
- Common in distributed systems

## High Availability

Running application in at least 2 AZs

### 2 Types of High Availability
1. **Passive:** Backup stays idle
2. **Active:** Multiple servers work together

## For EC2: High Availability and Scalability

- **Vertical Scaling:** Instance size increase
- **Horizontal Scaling:** Increasing number of instances (ASG helps scale out/in automatically)
- **High Availability:** Run instances for same application across multiple AZs

## Load Balancing

### Features
- Forward traffic to multiple servers (EC2 instances)
- Expose single point of access (DNS) of your application
- LB has health check mechanism
- Provides SSL termination (HTTPS -> HTTP)
- Enforces stickiness with cookies
- Separates public traffic from private traffic

### ELB (Elastic Load Balancer)
- Always available, guaranteed by AWS
- Setting up own LB is less costly but headache to manage and maintain

### Health Check
- LB does continuous health check for instances so it knows which instance is healthy and only forwards traffic to that instance
- Uses `/health` endpoint

## Types of Load Balancers

1. **Classic LB** = Not used
2. **ALB** = Application Load Balancer
3. **NLB** = Network Load Balancer
4. **GLB** = Gateway Load Balancer

### ALB (Application Load Balancer)
- Routes traffic based on URL path, headers, and other application-level details
- Works at application layer, Layer 7
- HTTP, HTTPS, WebSockets protocol

### NLB (Network Load Balancer)
- Routes traffic based on IP address and ports, not based on content of request
- Works at transport layer, Layer 4
- TCP, TLS (secure TCP), UDP

### GLB (Gateway Load Balancer)
- Routes IP packets, for firewall, intrusion detection
- Operates at network layer, Layer 3

**Note:** Some LBs can be setup as internal (private) and external (public)

## Load Balancer and Security Group

- For LB also we have Security Group, which has rules like who can access LB
- Then in EC2 instance Security Group, we setup inbound traffic to allow traffic to come only from Security Group of LB

## ALB and Target Group

### Overview
- All machines where traffic is going to go is grouped in Target Group
- ALB uses routing tables to route traffic to different target groups (TG1 = frontend, TG2 = backend, TG3 = service running user auth)
- ALB is great fit for microservices and container-based applications
- When containers run, they are assigned random ports. ALB can still forward traffic to dynamic ports

### For ALB, Target Group Could Be:
1. EC2 instance
2. ECS tasks
3. Lambda function
4. Private IP address

### Key Points
- ALB can route to multiple target groups
- Health check at target group level
- You get fixed hostname with ALB
- EC2 which is present in target group does not need to see IP of client
- IP of client is inserted in header `X-Forwarded-For`
- We can get port (`X-Forwarded-Port`) and proto (`X-Forwarded-Proto`)

### Traffic Flow
- Client talks to LB, LB does connection termination
- LB talks to EC2 using EC2's private IP
- For the EC2 instance to know client IP, it can look at extra headers sent in HTTP request: `X-Forwarded-Port` and `X-Forwarded-Proto`

## NLB (Network Load Balancer)

### Features
- Handles millions of requests per second
- Ultra-low latency
- When in exam it says that your application can be accessed within 1, 2, or 3 different IPs, think of NLB (we also have AWS Global Accelerator which can also be accessed by 2 Static IPs)
- No hostname unlike ALB because it routes traffic based on IP address rather than DNS name

### NLB and Target Group
- EC2 instance
- IP address (private)
- ALB = NLB in front of ALB, with NLB you get fixed IP address

**Summary:** NLB = Extreme performance, low latency, TCP, UDP, Static IPs (1, 2, or 3 static IPs)

## GLB (Gateway Load Balancer)

### Use Case
- Use GLB when we want traffic in network to go through firewall for intrusion detection, deep packet inspection, or modify payload at network level
- When traffic needs to be inspected before going to LB
- Uses GENEVE protocol on port 6081 => think GLB

### Target Group for GLB
1. EC2 instance
2. Private IP address

## Sticky Session

### Overview
- Same client is always redirected to same instance
- Works by sending cookies as part of request
- When we use sticky session, it may bring imbalance to LB
- **Note:** NLB works without cookies, it relies on client's IP address instead

### 2 Types of Cookies

**1. Application-Based Cookies:**

A. **Custom Cookies**
- Generated by target (application)
- Can include any custom attribute required by application
- Cookie name must be specified individually for each target group

B. **Application Cookies**
- Generated by LB
- Cookie name is `AWSALBAPP`

**2. Duration-Based Cookies**
- Cookies generated by LB
- Cookie name is `AWSALB` for ALB, `AWSELB` for CLB
- Cookie expiration is also set by LB

## Cross-Zone Load Balancing

Distribute traffic across multiple AZs

- With this enabled, each instance in any region distributes the traffic evenly
- **ALB:** Enabled by default, can be disabled at target group level not at ALB level, no charges for inter-AZ data
- **NLB/GLB:** Disabled by default, you pay charges for inter-AZ
- **CLB:** Disabled by default, no charges for inter-AZ data

## SSL/TLS

### Overview
- Traffic between client and LB is encrypted when using SSL/TLS
- Public SSL certificates are issued by Certificate Authorities (CA)
- SSL certificates have expiration date and should be renewed

## SSL and Load Balancer

### Flow

1. Client → HTTPS request to app.example.com
2. Load Balancer (ALB/NLB) receives request
3. Listener (HTTPS:443) checks incoming traffic on port 443
4. SNI (Server Name Indication) reads hostname (app.example.com) to pick correct SSL cert
5. ACM (AWS Certificate Manager) provides SSL certificate to LB
6. Connection Termination - LB decrypts HTTPS → becomes HTTP
7. LB forwards HTTP request to backend EC2 instances
8. EC2 processes, sends HTTP response back to LB
9. LB encrypts response → HTTPS back to client

### Key Points
1. **Listener:** Checks protocol/port (HTTP:80, HTTPS:443)
2. **SNI:** Multiple certs on one LB for multiple domains
3. **ACM:** Manages/renews SSL certs automatically
4. **Termination:** SSL handled by LB, not EC2 (reduces EC2 CPU load)

### Scenario: One ALB Hosting Multiple Domains

**Client 1 → https://shop.example.com**
1. Hits ALB
2. Listener (HTTPS:443) receives request
3. SNI reads hostname: shop.example.com
4. ACM provides cert for shop.example.com
5. LB decrypts with shop cert
6. Routes to Target Group A (Shop EC2 instances)

**Client 2 → https://api.example.com**
1. Hits same ALB
2. Same Listener (HTTPS:443)
3. SNI reads hostname: api.example.com
4. ACM provides cert for api.example.com
5. LB decrypts with api cert
6. Routes to Target Group B (API EC2 instances)

**Key:** SNI lets one ALB use multiple certs for multiple domains on same listener.

### SNI Support
- SNI works only with ALB/NLB, CloudFront
- Multiple SSL certificates => think ALB/NLB

### Classic LB
- Only one SSL certificate supported
- Have to use multiple CLBs to use multiple SSL certificates

### ALB/NLB
- Supports multiple listeners
- Uses SNI to make it work
- This means you can serve multiple domains with single LB

## Connection Draining

When instance is being removed or marked unhealthy, it is given some time to finish any active requests (default 300 seconds)

## ASG (Auto Scaling Group)

### Features
- Scale out, scale in
- Ensure we have minimum and maximum number of EC2 instances
- Automatically register new instances to load balancer
- Recreate EC2 instance if previous one becomes unhealthy
- ASG is free

### Configuration
- **Min Capacity:** When no load
- **Desired Capacity:** When expected TPS is coming
- **Max Capacity:** When TPS increases more than contract

## Scaling Based on CloudWatch Alarm

- Alarm monitors metrics like CPU, Memory
- Checks these metrics across whole EC2 instances
- Based on alarm, create scale out and scale in policies

## Scaling Policies

### 1. Dynamic Scaling

**A. Target Tracking Scaling**
- Average CPU to 40%, ASG will try to maintain 40% by doing scale out/in

**B. Simple/Step Scaling**
- Fine-grained control over scaling
- When CPU > 70% => add 2 units
- When CPU < 30% => remove 1

### 2. Scheduled Scaling
- In peak hour like 7 PM scale out, once peak hour is done scale in

### 3. Predictive Scaling
- Analyze historical data => generate forecast => schedule scaling

## Good Metrics to Scale On

- CPU, Memory usage
- Request count per target (prevent single instance from being overloaded)
- Average network in/out = how much data is being transferred
- Custom metrics in CloudWatch

## Auto Scaling Cooldown

- After scaling activity, we have cooldown of 300 seconds (5 mins)
- During cooldown period, ASG will not launch or terminate additional instances (to allow metrics to stabilize)
